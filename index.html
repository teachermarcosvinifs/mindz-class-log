<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Registro de Aula</title>

<style>
/* ================= RESET ================= */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* ================= BASE ================= */
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(135deg, #667eea, #764ba2);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

.container {
  background: #fff;
  width: 100%;
  max-width: 720px;
  border-radius: 14px;
  padding: 36px;
  box-shadow: 0 30px 80px rgba(0,0,0,.35);
}

h1 {
  font-size: 28px;
  margin-bottom: 6px;
}

.subtitle {
  font-size: 14px;
  color: #666;
  margin-bottom: 28px;
}

/* ================= FORM ================= */
.form-group {
  margin-bottom: 26px;
}

label {
  font-weight: 600;
  font-size: 14px;
  display: block;
  margin-bottom: 8px;
}

.hint {
  font-weight: 400;
  font-size: 12px;
  color: #888;
}

/* ================= MULTI SELECT ================= */
.multi-select {
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  padding: 10px;
  cursor: text;
}

.multi-select:focus-within {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102,126,234,.15);
}

.selected-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 6px;
}

.chip {
  background: #667eea;
  color: #fff;
  padding: 6px 10px;
  border-radius: 18px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.chip span {
  cursor: pointer;
  font-weight: bold;
}

.search-input {
  border: none;
  outline: none;
  font-size: 14px;
  width: 100%;
}

.dropdown {
  border: 1px solid #ddd;
  border-radius: 6px;
  max-height: 180px;
  overflow-y: auto;
  margin-top: 6px;
  display: none;
}

.dropdown.active {
  display: block;
}

.dropdown div {
  padding: 10px;
  cursor: pointer;
}

.dropdown div:hover {
  background: #f2f4ff;
}

/* ================= PRINTS ================= */
.print-zone {
  border: 3px dashed #667eea;
  border-radius: 10px;
  padding: 30px;
  text-align: center;
  background: #f8f9ff;
  cursor: pointer;
  transition: .2s;
}

.print-zone:hover {
  background: #eef0ff;
}

.print-zone.drag {
  background: #e5e8ff;
}

.print-text {
  font-weight: 600;
  color: #667eea;
}

.print-hint {
  font-size: 12px;
  color: #888;
  margin-top: 4px;
}

.gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px,1fr));
  gap: 10px;
  margin-top: 14px;
}

.gallery img {
  width: 100%;
  height: 90px;
  object-fit: cover;
  border-radius: 6px;
}

.counter {
  font-size: 12px;
  color: #666;
  text-align: center;
  margin-top: 8px;
}

/* ================= TEXTAREAS ================= */
textarea {
  width: 100%;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  padding: 12px;
  font-size: 14px;
  resize: vertical;
}

textarea:focus {
  outline: none;
  border-color: #667eea;
}

/* ================= BUTTONS ================= */
.buttons {
  display: flex;
  gap: 12px;
  margin-top: 30px;
}

button {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.submit {
  background: linear-gradient(135deg,#667eea,#764ba2);
  color: #fff;
}

.clear {
  background: #eee;
}
</style>
</head>

<body>
<div class="container">
<h1>üìù Registro de Aula</h1>

<!-- ALUNOS -->
<div class="form-group">
<label>Alunos / Turma <span class="hint">(busque e selecione um ou mais)</span></label>

<div class="multi-select" id="multiSelect">
  <div class="selected-list" id="selectedList"></div>
  <input class="search-input" id="searchInput" placeholder="Digite o nome do aluno..."/>
</div>
<div class="dropdown" id="dropdown"></div>
</div>

<!-- PRINTS -->
<div class="form-group">
<label>üì∏ Prints da aula <span class="hint">(opcional ‚Ä¢ at√© 5 ‚Ä¢ Ctrl+V)</span></label>

<div class="print-zone" id="printZone">
  <div class="print-text">Cole a imagem aqui (Ctrl + V)</div>
  <div class="print-hint">ou arraste / clique para selecionar</div>
</div>

<input type="file" id="fileInput" accept="image/*" multiple hidden/>
<div class="gallery" id="gallery"></div>
<div class="counter" id="counter">0 de 5 prints</div>
</div>

<!-- LINKS -->
<div class="form-group">
<label>Links <span class="hint">(opcional ‚Ä¢ um por linha)</span></label>
<textarea id="links"></textarea>
</div>

<div class="form-group">
<label>PDFs / Apostilas <span class="hint">(opcional ‚Ä¢ um por linha)</span></label>
<textarea id="pdfs"></textarea>
</div>

<div class="form-group">
<label>V√≠deos <span class="hint">(opcional ‚Ä¢ arquivos pr√≥prios)</span></label>
<textarea id="videos"></textarea>
</div>

<div class="form-group">
<label>Assunto da Aula <span class="hint">(opcional)</span></label>
<textarea id="subject"></textarea>
</div>

<div class="buttons">
<button class="submit">Enviar Registro</button>
<button class="clear" onclick="location.reload()">Limpar</button>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycby-yS1wFZ6eCZVt5jarO1RyOuG1EBQjS8PhsVdlGLpEwX2HpW5LsffOalNn4PN0BHFJ/exec";

/* ================= STATE ================= */
let students = [];
let selected = [];
let prints = [];

/* ================= LOAD STUDENTS ================= */
fetch(API_URL + "?action=get_students")
.then(r=>r.json())
.then(d=>students=d.students||[]);

/* ================= MULTI SELECT ================= */
const input = document.getElementById("searchInput");
const dropdown = document.getElementById("dropdown");
const selectedList = document.getElementById("selectedList");

input.addEventListener("input",()=>{
  dropdown.innerHTML="";
  const v=input.value.toLowerCase();
  if(!v) return dropdown.classList.remove("active");
  students.filter(s=>s.name.toLowerCase().includes(v))
  .forEach(s=>{
    const div=document.createElement("div");
    div.textContent=s.name;
    div.onclick=()=>addStudent(s);
    dropdown.appendChild(div);
  });
  dropdown.classList.add("active");
});

function addStudent(s){
  if(selected.find(x=>x.id===s.id)) return;
  selected.push(s);
  renderSelected();
  input.value="";
  dropdown.classList.remove("active");
}

function removeStudent(id){
  selected=selected.filter(s=>s.id!==id);
  renderSelected();
}

function renderSelected(){
  selectedList.innerHTML="";
  selected.forEach(s=>{
    const chip=document.createElement("div");
    chip.className="chip";
    chip.innerHTML=`${s.name} <span onclick="removeStudent('${s.id}')">‚úï</span>`;
    selectedList.appendChild(chip);
  });
}

/* ================= PRINTS CTRL+V ================= */
const zone=document.getElementById("printZone");
const gallery=document.getElementById("gallery");
const counter=document.getElementById("counter");
const fileInput=document.getElementById("fileInput");

zone.onclick=()=>fileInput.click();

document.addEventListener("paste",e=>{
  [...e.clipboardData.items].forEach(i=>{
    if(i.type.startsWith("image/")){
      addPrint(i.getAsFile());
    }
  });
});

fileInput.onchange=e=>{
  [...e.target.files].forEach(addPrint);
};

function addPrint(file){
  if(prints.length>=5) return;
  const r=new FileReader();
  r.onload=e=>{
    prints.push(e.target.result);
    renderPrints();
  };
  r.readAsDataURL(file);
}

function renderPrints(){
  gallery.innerHTML="";
  prints.forEach(p=>{
    const img=document.createElement("img");
    img.src=p;
    gallery.appendChild(img);
  });
  counter.textContent=`${prints.length} de 5 prints`;
}
</script>
</body>
</html>

<script>
/* ================= SUBMIT ================= */
const submitBtn = document.querySelector(".submit");

submitBtn.addEventListener("click", async () => {
  if (selected.length === 0) {
    alert("Selecione pelo menos um aluno.");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = "Enviando...";

  try {
    const payload = {
      student_ids: selected.map(s => s.id),
      images: prints,
      links: document.getElementById("links").value,
      pdfs: document.getElementById("pdfs").value,
      videos: document.getElementById("videos").value,
      subject: document.getElementById("subject").value
    };

    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    });

    const data = await res.json();

    if (!data.success) {
      throw new Error(data.error || "Erro desconhecido");
    }

    alert(`Registro enviado com sucesso para ${data.students} aluno(s)!`);
    location.reload();

  } catch (err) {
    alert("Erro ao enviar registro:\n" + err.message);
    submitBtn.disabled = false;
    submitBtn.textContent = "Enviar Registro";
  }
});
</script>

